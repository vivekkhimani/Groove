<!DOCTYPE html>
<html lang="en">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.1.2/handlebars.min.js"></script>

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Groove: Recommendations</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="https://www.cs.drexel.edu/~vck29/pennapps_static/img/favicon.png" rel="icon">
  <link href="https://www.cs.drexel.edu/~vck29/pennapps_static/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="https://www.cs.drexel.edu/~vck29/pennapps_static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/assets/vendor/icofont/icofont.min.css" rel="stylesheet">
  <link href="/static/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="https://www.cs.drexel.edu/~vck29/pennapps_static/venobox/venobox.css" rel="stylesheet">
  <link href="https://www.cs.drexel.edu/~vck29/pennapps_static/owl.carousel/assets/owl.carousel.min.css" rel="stylesheet">
  <link href="https://www.cs.drexel.edu/~vck29/pennapps_static/aos/aos.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="/static/assets/css/home_style.css" rel="stylesheet">

</head>

<body>

  <!-- ======= Mobile nav toggle button ======= -->
  <button type="button" class="mobile-nav-toggle d-xl-none"><i class="icofont-navigation-menu"></i></button>

  <!-- ======= Header ======= -->
  <header id="header">
    <div class="d-flex flex-column">

      <div class="profile">
        <img src="" alt="profile-picture" class="img-fluid rounded-circle" id="profile-pic">
        <h1 class="text-light" id="displayname-href"></h1>
        <h5 class="text-light" id="email-href"></h5>
      </div>

      <nav class="nav-menu">
        <ul>
          <li class="active"><a href="#"><i class="bx bx-home"></i> <span>Home</span></a></li>
          <li><a href="#about"><i class="bx bx-user"></i> <span>Recommendations</span></a></li>
          <li><a href="#plots"><i class="bx bx-file-blank"></i> <span>Plots</span></a></li>

        </ul>
      </nav><!-- .nav-menu -->
      <button type="button" class="mobile-nav-toggle d-xl-none"><i class="icofont-navigation-menu"></i></button>

    </div>
  </header><!-- End Header -->

  <!-- ======= Hero Section ======= -->
  <section id="hero" class="d-flex flex-column justify-content-center align-items-center">
    <div class="hero-container" data-aos="fade-in">
      <h1>Alex Smith</h1>
      <p>I'm <span class="typed" data-typed-items="Designer, Developer, Freelancer, Photographer"></span></p>
    </div>
  </section><!-- End Hero -->

  <main id="main">

    <!-- ======= About Section ======= -->
    <section id="about" class="about">
      <div class="container">

        <div class="section-title">
          <h2>About</h2>
          <p>Magnam dolores commodi suscipit. Necessitatibus eius consequatur ex aliquid fuga eum quidem. Sit sint consectetur velit. Quisquam quos quisquam cupiditate. Et nemo qui impedit suscipit alias ea. Quia fugiat sit in iste officiis commodi quidem hic quas.</p>
        </div>

        <div class="row">
          <div class="col-lg-4" data-aos="fade-right">
            <img src="https://www.cs.drexel.edu/~vck29/pennapps_static/img/profile-img.jpg" class="img-fluid" alt="">
          </div>
          <div class="col-lg-8 pt-4 pt-lg-0 content" data-aos="fade-left">
            <h3>UI/UX Designer &amp; Web Developer.</h3>
            <p class="font-italic">
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore
              magna aliqua.
            </p>
            <div class="row">
              <div class="col-lg-6">
                <ul>
                  <li><i class="icofont-rounded-right"></i> <strong>Birthday:</strong> 1 May 1995</li>
                  <li><i class="icofont-rounded-right"></i> <strong>Website:</strong> www.example.com</li>
                  <li><i class="icofont-rounded-right"></i> <strong>Phone:</strong> +123 456 7890</li>
                  <li><i class="icofont-rounded-right"></i> <strong>City:</strong> City : New York, USA</li>
                </ul>
              </div>
              <div class="col-lg-6">
                <ul>
                  <li><i class="icofont-rounded-right"></i> <strong>Age:</strong> 30</li>
                  <li><i class="icofont-rounded-right"></i> <strong>Degree:</strong> Master</li>
                  <li><i class="icofont-rounded-right"></i> <strong>PhEmailone:</strong> email@example.com</li>
                  <li><i class="icofont-rounded-right"></i> <strong>Freelance:</strong> Available</li>
                </ul>
              </div>
            </div>
            <p>
              Officiis eligendi itaque labore et dolorum mollitia officiis optio vero. Quisquam sunt adipisci omnis et ut. Nulla accusantium dolor incidunt officia tempore. Et eius omnis.
              Cupiditate ut dicta maxime officiis quidem quia. Sed et consectetur qui quia repellendus itaque neque. Aliquid amet quidem ut quaerat cupiditate. Ab et eum qui repellendus omnis culpa magni laudantium dolores.
            </p>
          </div>
        </div>
      </div>
    </section><!-- End About Section -->

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="container">
      <div class="copyright">
        &copy; Copyright <strong><span>iPortfolio</span></strong>
      </div>
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/iportfolio-bootstrap-portfolio-websites-template/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End  Footer -->

  <a href="#" class="back-to-top"><i class="icofont-simple-up"></i></a>

  <!-- Vendor JS Files -->
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/jquery/jquery.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/jquery.easing/jquery.easing.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/waypoints/jquery.waypoints.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/counterup/counterup.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/venobox/venobox.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/owl.carousel/owl.carousel.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/typed.js/typed.min.js"></script>
  <script src="https://www.cs.drexel.edu/~vck29/pennapps_static/aos/aos.js"></script>

  <!-- Template Main JS File -->
  <script src="/static/assets/js/portmain.js"></script>
  <script>
    (function() {

        var stateKey = 'spotify_auth_state';
        const ngrok_url = 'https://groove-music-289322.uc.r.appspot.com';
        const user_playlist = [];

        function getHashParams() {
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g,
                q = window.location.hash.substring(1);
            while (e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            }
            return hashParams;
        }

        var params = getHashParams();

        var access_token = params.access_token,
            state = params.state,
            storedState = localStorage.getItem(stateKey);

        if (access_token && (state == null || state !== storedState)) {
            alert('There was an error during the authentication');
        } else {
            localStorage.removeItem(stateKey);
            if (access_token) {
                $.ajax({
                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: function(response) {
                        console.log(response);
                        document.getElementById('profile-pic').src = response['images'][0]['url'];
                        const email_href = 'mailto:'+response['email'];
                        document.getElementById('displayname-href').innerHTML = '<a href="'+response['external_urls']['spotify']+'" target=_blank>'+response['display_name']+'</a>';
                         document.getElementById('email-href').innerHTML = '<a href="'+email_href+'" target=_blank>'+response['email']+'</a>';
                        // document.getElementById('country-href').innerHTML = 'Country: ' + response['country'];
                        // if (response['product'] === 'premium'){
                        //     document.getElementById('premium-href').innerHTML = 'Premium User';
                        // }
                    }
                });
            }
        }

        //get the user playlists and display it in the UI
        if (access_token) {
            $.ajax({
                url: ngrok_url + '/get_user_playlist',
                type: 'get',
                data: {
                    access_token: access_token
                },
                success: function(response) {
                    response.forEach((item, index) => {
                        user_playlist.push(item[0]);
                        const div_id = String(index)
                        const append_val = '<button type="button" class="btn btn-secondary btn-lg btn-block" id="' + div_id + '">' + item[1] + '</button>'
                        document.getElementById('custom_user_playlists').innerHTML += append_val
                    })
                    //playlist listeners
                    console.log(user_playlist.length);
                    if (user_playlist.length > 0) {
                        user_playlist.forEach((item, index) => {
                            const elem = document.getElementById(String(index))
                            console.log(elem)
                            elem.addEventListener('click', function(){
                                $.ajax({
                                    url: ngrok_url + '/playlist',
                                    type: 'get',
                                    data: {
                                        access_token: access_token,
                                        req_id: item
                                    },
                                    success: function(response) {
                                        generate_recommendation_table(response);
                                        //console.log(response);
                                    }
                                })
                            })
                        })
                    }

                }
            })
        }

        function generate_recommendation_table(response){
                    const plot_link = response['plot'];
                    const rec_list = response['recommendations'];
                    const rec_div = document.getElementById('recomm');
                    rec_div.innerHTML = '';
                    const h5_tag = document.createElement('h5');
                    h5_tag.innerHTML = "Here's your recommendations:"
                    rec_div.appendChild(h5_tag);

                    const display_table = document.createElement('table');
                    const header_row = display_table.insertRow(0);

                    const cell1 = header_row.insertCell(0); //sr no.
                    const cell2 = header_row.insertCell(1); //recommended song
                    const cell3 = header_row.insertCell(2); //base song
                    const cell4 = header_row.insertCell(3); //associated cluster
                    const cell5 = header_row.insertCell(4);

                    cell1.innerHTML = "<b>Sr NO.</b>";
                    cell2.innerHTML = "<b>Recommended Song</b>";
                    cell3.innerHTML = "<b>Base Song</b>";
                    cell4.innerHTML = "<b>Associated Cluster</b>";
                    cell5.innerHTML = "<b>Approval</b>";

                    var row = 1;
                    var td_count, data_row, dc;
                    for (i=0; i<rec_list.length; i++){
                        td_count = 0;
                        data_row = display_table.insertRow(row);

                        while(td_count < 5){
                            dc = data_row.insertCell(td_count);

                            //sr no.
                            if (td_count == 0){
                                dc.innerHTML = '<b>'+String(i)+'</b>';
                            }

                            //recommended song
                            if (td_count == 1){
                                const recommended_name = rec_list[i]['recommended_track_name'];
                                const recommended_url = rec_list[i]['recommended_track_url'];
                                dc.innerHTML = '<a href="'+recommended_url+'">'+recommended_name+'</a>';
                            }

                            //base song
                            if (td_count == 2){
                                const base_name = rec_list[i]['base_track_name'];
                                const base_url = rec_list[i]['base_track_url'];
                                dc.innerHTML = '<a href="'+base_url+'">'+base_name+'</a>';
                            }

                            //associated cluster
                            if (td_count == 3){
                                const associated_cluster = rec_list[i]['associated_cluster'];
                                dc.innerHTML = '<b>'+String(associated_cluster)+'</b>';
                            }

                            //approval
                            if (td_count == 4){
                                const id_val = "recomm_"+String(i);
                                dc.innerHTML = '<input type="checkbox" id="'+ id_val+'" name="' + id_val + '">';
                            }
                            td_count++;
                        }
                        row++;
                        rec_div.appendChild(display_table);
                        rec_div.appendChild(document.createElement('br'));
                    }
                    const h5_tag1 = document.createElement('h5');
                    h5_tag1.innerHTML = "Recommended Cluster Distribution";
                    rec_div.appendChild(h5_tag1);
                    const img_tag = document.createElement('img');
                    img_tag.src = plot_link;
                    img_tag.class = 'img-fluid';
                    img_tag.alt = 'plot';
                    rec_div.appendChild(img_tag);
        }

        //top songs listener
        document.getElementById('top_songs').addEventListener('click', function() {
            $.ajax({
                url: ngrok_url + '/top_songs',
                type: 'get',
                data: {
                    access_token: access_token
                },
                success: function(response) {
                    generate_recommendation_table(response);
                }
            })
        })

        //recently played listener
        document.getElementById('recently_played').addEventListener('click', function() {
            $.ajax({
                url: ngrok_url + '/recently_played',
                type: 'get',
                data: {
                    access_token: access_token
                },
                success: function(response) {
                    generate_recommendation_table(response);
                }
            })
        })

        //saved tracks listener
        document.getElementById('saved_tracks').addEventListener('click', function() {
            $.ajax({
                url: ngrok_url + '/saved_tracks',
                type: 'get',
                data: {
                    access_token: access_token
                },
                success: function(response) {
                    generate_recommendation_table(response);
                }
            })
        })

        //helper function
        function playlist_helper(item, index) {
            document.getElementById(String(index)).addEventListener('click',
                function() {
                    $.ajax({
                        url: ngrok_url + '/playlist',
                        type: 'get',
                        data: {
                            access_token: access_token,
                            req_id: item
                        },
                        success: function(response) {
                            console.log(response)
                        }
                    })
                })
        }

    })();
    </script>
</body>

</html>